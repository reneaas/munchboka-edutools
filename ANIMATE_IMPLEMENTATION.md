# Animate Directive - Implementation Guide

This document describes the implementation of the `animate` directive for creating animated plots with transparent backgrounds.

## Overview

The `animate` directive extends the `plot` directive to generate animations by varying one or more variables across frames. Each frame is generated using the plot directive logic, then assembled into an animated WebP or GIF file.

## Architecture

### File Structure

```
src/munchboka_edutools/directives/
â”œâ”€â”€ animate.py          # Main directive implementation
â”œâ”€â”€ plot.py             # Base plot directive (reused for frames)
â””â”€â”€ ...

tests/
â”œâ”€â”€ test_animate.py     # Unit tests
â””â”€â”€ ...

book/examples/
â”œâ”€â”€ animate.md          # Comprehensive examples
â””â”€â”€ ...
```

### Core Components

1. **AnimateDirective Class**: Main Sphinx directive
2. **Variable Parsing**: Extract animation variable and values
3. **Frame Generation**: Generate SVG for each frame
4. **Format Conversion**: Convert SVG â†’ PNG with transparency
5. **Animation Assembly**: Combine frames into WebP/GIF

## Implementation Details

### 1. Variable Parsing

```python
def _parse_animate_var(var_spec: str) -> Tuple[str, List[float]]:
    """Parse animation variable specification.
    
    Format: "name, start, end, count"
    Example: "a, 0, 10, 20" â†’ variable 'a' from 0 to 10 in 20 steps
    """
```

**Features:**
- Supports SymPy expressions in start/end values
- Linear interpolation across frames
- Validation of variable names and counts

### 2. Variable Substitution

```python
def _substitute_variable(content: str, var_name: str, var_value: float) -> str:
    """Replace animation variable with numeric value in content.
    
    Uses word boundaries to avoid replacing parts of other identifiers.
    Example: Replace 'a' in 'sin(a*x)' but not in 'alpha'
    """
```

**Implementation:**
- Regex with word boundaries: `r'\b' + var_name + r'\b'`
- Smart formatting: decimals for small values, scientific notation for large
- Preserves mathematical expressions

### 3. Frame Generation

Each frame is generated by:

1. **Substitute variable**: Replace animation variable with current frame value
2. **Generate SVG**: Use plot directive logic to create SVG
3. **Convert to PNG**: Use cairosvg for transparent PNG
4. **Cache frame**: Store temporarily for assembly

**Key Challenge**: Reusing plot directive logic without full Sphinx context

**Solution**: Extract plot generation into reusable functions or directly call matplotlib with plotmath

### 4. SVG â†’ PNG Conversion

```python
def _svg_to_png(self, svg_path: str, png_path: str) -> None:
    """Convert SVG to PNG with transparency using cairosvg."""
    import cairosvg
    cairosvg.svg2png(
        url=svg_path,
        write_to=png_path,
        background_color=None,  # Transparent!
        dpi=150,  # High quality
    )
```

**Why cairosvg?**
- Pure Python (no external dependencies like ImageMagick)
- Excellent transparency support
- High-quality rendering
- Easy to install: `pip install cairosvg`

### 5. Animation Assembly

#### WebP (Default)

```python
def _create_webp(self, frame_paths, output_path, duration, loop):
    """Create animated WebP from PNG frames."""
    from PIL import Image
    
    images = [Image.open(fp).convert("RGBA") for fp in frame_paths]
    
    images[0].save(
        output_path,
        format="WEBP",
        save_all=True,
        append_images=images[1:],
        duration=duration,
        loop=0 if loop else 1,
        quality=85,  # Good quality, reasonable size
    )
```

**WebP Advantages:**
- 30-50% smaller than GIF
- Better quality
- Native transparency
- Good browser support (Chrome, Firefox, Edge, Safari 14+)

#### GIF (Fallback)

```python
def _create_gif(self, frame_paths, output_path, duration, loop):
    """Create animated GIF from PNG frames."""
    from PIL import Image
    
    images = [Image.open(fp).convert("RGBA") for fp in frame_paths]
    
    images[0].save(
        output_path,
        format="GIF",
        save_all=True,
        append_images=images[1:],
        duration=duration,
        loop=0 if loop else 1,
        disposal=2,  # Clear previous frame (important!)
        transparency=0,
        optimize=False,  # Preserve transparency
    )
```

**GIF Considerations:**
- Universal compatibility
- Larger file size
- `disposal=2` crucial for transparency
- Limited color palette (256 colors)

### 6. Caching

Animations are cached based on content hash:

```python
hash_key = _hash_key(
    animate_var_spec,
    output_format,
    frame_duration,
    loop,
    content_for_hash,
    str(self.options),
)
```

**Cache Invalidation:**
- Any content change
- Option change
- `nocache` flag

**Cache Location:**
- Source: `<srcdir>/_static/animate/`
- Build: `<outdir>/_static/animate/`

## Dependencies

### Required

```toml
dependencies = [
    "Pillow>=10.0.0",      # Image manipulation and animation
    "cairosvg>=2.7.0",     # SVG â†’ PNG with transparency
    "imageio>=2.31.0",     # Fallback WebP support
]
```

### System Requirements

**cairosvg** requires system libraries:
- **Linux**: `libcairo2-dev`, `libffi-dev`
- **macOS**: Already available (via Homebrew cairo)
- **Windows**: Cairo DLLs (usually bundled with cairosvg)

## Performance Considerations

### Frame Generation

**Current**: Sequential generation
```python
for value in var_values:
    generate_frame(value)
```

**Future Optimization**: Parallel generation
```python
from multiprocessing import Pool
with Pool() as pool:
    pool.map(generate_frame, var_values)
```

**Trade-offs:**
- Parallel: Faster for many frames
- Sequential: Simpler, works everywhere
- For 20-40 frames: sequential is fine

### File Sizes

**Typical sizes** (30 frames, 800x600px):
- WebP: 100-300 KB
- GIF: 300-800 KB

**Reduction strategies:**
1. Use WebP (automatic 50% reduction)
2. Reduce frame count
3. Lower FPS (doesn't affect quality, just playback)
4. Simplify plot (fewer elements, lower fontsize)
5. Smaller figsize

## Testing Strategy

### Unit Tests

1. **Variable parsing**: `test_animate_var_parsing()`
2. **Substitution**: `test_variable_substitution()`
3. **Expression evaluation**: `test_eval_expr()`
4. **Boolean parsing**: `test_parse_bool()`
5. **Dependency imports**: `test_animate_directive_imports()`

### Integration Tests

Would require full Sphinx build:
```python
def test_animate_build(tmpdir):
    """Test building a book with animate directive."""
    # Create test book
    # Build with Sphinx
    # Verify animation file exists
    # Check file format
```

### Manual Testing

```markdown
:::{animate}
animate-var: a, 0, 10, 20
function: sin(a*x)
xmin: -10
xmax: 10
:::
```

Build and verify:
1. Animation file created
2. Correct format (WebP)
3. Transparent background
4. Smooth playback
5. Correct frame count

## Future Enhancements

### Priority 1: Core Features

1. **Multiple variables**: `animate-var-2:` for 2D parameter space
2. **Better plot reuse**: Direct integration with PlotDirective
3. **Parallel frame generation**: Speed up for many frames

### Priority 2: Advanced Features

4. **Custom interpolation**: `interpolation: linear|ease-in|ease-out`
5. **Frame callbacks**: User-defined frame generation
6. **Video formats**: MP4/WebM support via ffmpeg
7. **Frame caching**: Cache individual frames, not just final animation

### Priority 3: Quality of Life

8. **Progress indicator**: Show progress during long builds
9. **Frame preview**: Generate preview GIF with fewer frames
10. **Auto-optimization**: Automatically adjust quality based on size
11. **Fallback frames**: If animation fails, show first/last frame

## Known Limitations

1. **No multi-variable support**: Only one animation variable per directive
2. **Sequential generation**: No parallelization yet
3. **Limited interpolation**: Only linear interpolation
4. **Format detection**: No automatic format selection based on browser
5. **No frame rate adaptation**: Fixed FPS, no adaptive frame rate

## Troubleshooting

### Common Issues

**1. ImportError: cairosvg**
```bash
pip install cairosvg
# On Linux: sudo apt-get install libcairo2-dev
```

**2. Animation not transparent**
- Check format (WebP/GIF both support transparency)
- Verify cairosvg is rendering correctly
- Check browser support

**3. Large file sizes**
- Use WebP instead of GIF
- Reduce frame count
- Lower FPS (doesn't affect quality)
- Simplify plot content

**4. Slow generation**
- Reduce frame count
- Simplify plot (fewer functions, points, etc.)
- Use smaller figsize
- Future: will add parallel generation

## Integration with Existing Code

### With Plot Directive

The animate directive **reuses** plot directive logic:

```python
from munchboka_edutools.directives.plot import PlotDirective

# Inherit option_spec
option_spec = {
    **PlotDirective.option_spec,
    'animate-var': ...,
}
```

### With Multi-Plot2

Works automatically because animate returns a standard `nodes.figure`:

```markdown
:::::{multi-plot2}
rows: 1
cols: 2

:::{animate}
...
:::

:::{animate}
...
:::
:::::
```

### With Sphinx Build Process

1. **builder-inited**: Set up output directories
2. **doctree-resolved**: Generate animations (if needed)
3. **build-finished**: Copy to output

## Code Quality

### Type Hints

All functions use type hints:
```python
def _parse_animate_var(var_spec: str) -> Tuple[str, List[float]]:
    ...
```

### Error Handling

Graceful degradation:
- Invalid variable spec â†’ error message, no crash
- Missing dependencies â†’ clear error with install instructions
- Generation failure â†’ error message with details

### Documentation

- Comprehensive docstrings
- Examples in comments
- Quickstart guide
- Full examples document

## Version History

- **v0.2.8**: Initial implementation with full features
  - WebP and GIF support
  - Transparent backgrounds
  - Variable substitution with SymPy expressions
  - Comprehensive examples and documentation
  - Unit tests

## Contributing

To extend the animate directive:

1. **Add new feature**: Modify `animate.py`
2. **Add tests**: Update `test_animate.py`
3. **Document**: Update examples in `animate.md`
4. **Test manually**: Build example book
5. **Update README**: Mention new feature

## References

- [Pillow Documentation](https://pillow.readthedocs.io/)
- [cairosvg Documentation](https://cairosvg.org/)
- [imageio Documentation](https://imageio.readthedocs.io/)
- [WebP Format](https://developers.google.com/speed/webp)
- [Matplotlib Animation](https://matplotlib.org/stable/api/animation_api.html)

## Summary

The animate directive provides a powerful, easy-to-use way to create mathematical animations with:

âœ… **Simple syntax**: Just add `animate-var:` to any plot  
âœ… **Full plot features**: All plot directive options work  
âœ… **Transparent backgrounds**: Perfect for web integration  
âœ… **Modern formats**: WebP for best quality/size, GIF for compatibility  
âœ… **Expression support**: SymPy expressions in variables  
âœ… **Automatic caching**: Fast rebuilds  
âœ… **Clean code**: Type hints, tests, documentation

Perfect for creating engaging mathematical content! ðŸŽ¬ðŸ“Š
